<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Главная</title>
<link rel="stylesheet" href="style.css">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB7QbVxGHR7Qm8o8Wzl_wxsCpzMUdS5rws",
  authDomain: "gdboard-add4a.firebaseapp.com",
  projectId: "gdboard-add4a",
  storageBucket: "gdboard-add4a.firebasestorage.app",
  messagingSenderId: "883125028740",
  appId: "1:883125028740:web:c504de4139943b8606bfd1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const nickEl = document.getElementById("nick");
const pointsEl = document.getElementById("points");
const rankEl = document.getElementById("rank");
const leaderboardBtn = document.getElementById("leaderboardBtn");
const checkBtnContainer = document.getElementById("checkBtnContainer");

onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "index.html";

  const userRef = doc(db, "users", user.uid);
  const userSnap = await getDoc(userRef);
  if (!userSnap.exists()) return window.location.href = "index.html";

  const data = userSnap.data();

  // Проверка верификации
  if (data.situation !== "verified") return window.location.href = "nick.html";

  nickEl.textContent = data.nick;
  pointsEl.textContent = data.points;

  // Кнопка "Проверить" для модеров и старших модеров
  if (data.role === "moderator" || data.role === "elder") {
    const btn = document.createElement("button");
    btn.textContent = "Проверить";
    btn.addEventListener("click", () => {
      if (data.role === "moderator") {
        window.location.href = "moderator.html";
      } else if (data.role === "elder") {
        window.location.href = "elder.html";
      }
    });
    checkBtnContainer.appendChild(btn);
  }

  // Рассчёт ранга
  const usersRef = collection(db, "users");
  const q = query(usersRef, where("situation", "==", "verified"), orderBy("points", "desc"));
  const snapshot = await getDocs(q);

  const usersArray = snapshot.docs.map(docItem => docItem.data());
  let prevPoints = null;
  let prevRank = 0;
  let skip = 1;

  for (let i = 0; i < usersArray.length; i++) {
    const userData = usersArray[i];
    let rank;
    if (prevPoints === null || userData.points < prevPoints) {
      rank = prevRank + skip;
      skip = 1;
    } else {
      rank = prevRank;
      skip++;
    }
    prevPoints = userData.points;
    prevRank = rank;

    if (userData.nick === data.nick) {
      rankEl.textContent = rank;
      break;
    }
  }

  leaderboardBtn.addEventListener("click", () => {
    window.location.href = "leaderboard.html";
  });
});
</script>
</head>
<body>
<h1>Привет, <span id="nick"></span>!</h1>
<p>Баллы: <span id="points"></span></p>
<p>Место: <span id="rank"></span></p>

<div id="checkBtnContainer"></div>

<button id="leaderboardBtn">Лидерборд</button>
</body>
</html>
