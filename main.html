<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Главная</title>
<style>
body {
  margin:0; padding:20px;
  font-family:'Orbitron', sans-serif;
  background:#0b0c10;
  color:#00f0ff;
  display:flex; flex-direction:column; align-items:center;
}
h1 { font-size:2.5em; text-shadow:0 0 10px #00f0ff; margin-bottom:20px;}
.player-card {
  background:rgba(0,0,0,0.55); border:1px solid rgba(0,255,255,0.2);
  border-radius:10px; padding:15px 25px; width:300px; text-align:center;
  box-shadow:0 2px 15px rgba(0,255,255,0.3);
}
.button {
  margin-top:20px; padding:10px 20px;
  border:none; border-radius:8px; background:#00a0ff; color:#000;
  font-weight:bold; cursor:pointer; transition:0.3s;
}
.button:hover { background:#00f0ff; color:#000; box-shadow:0 0 10px #00f0ff;}
</style>
</head>
<body>
<h1>Главная</h1>
<div class="player-card" id="playerCard">
  <div>Ник: <span id="nick">...</span></div>
  <div>Баллы: <span id="points">0</span></div>
  <div>Место: <span id="rank">0</span></div>
</div>
<button class="button" id="checkBtn">Проверить</button>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = { /* твой config */ };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const nickEl=document.getElementById('nick');
const pointsEl=document.getElementById('points');
const rankEl=document.getElementById('rank');
const checkBtn=document.getElementById('checkBtn');

onAuthStateChanged(auth, async user=>{
  if(!user) return window.location.href='index.html';
  const userSnap = await getDoc(doc(db,'users',user.uid));
  if(!userSnap.exists()) return window.location.href='index.html';
  const data = userSnap.data();
  if(data.situation!=='verified') return window.location.href='nick.html';
  nickEl.textContent = data.nick||'Не указан';
  pointsEl.textContent = data.points||0;

  // вычисляем место
  const usersRef = collection(db,'users');
  const q = query(usersRef, orderBy('points','desc'));
  const snapshot = await getDocs(q);
  const usersArray = snapshot.docs.map(d=>({id:d.id,...d.data()}));
  let rank=1, prevPoints=null, skip=1;
  for(let u of usersArray){
    if(u.situation!=='verified' && u.role==='player') continue;
    if(prevPoints===null || u.points<prevPoints){ rank+=skip-1; skip=1;} else {skip++;}
    prevPoints=u.points;
    if(u.id===user.uid){rankEl.textContent=rank; break;}
  }

  // кнопка проверки
  checkBtn.addEventListener('click',()=>{
    if(data.role==='moderator'||data.role==='elder'){
      window.location.href=(data.role==='elder')?'elder.html':'moderator.html';
    } else {
      alert('Ошибка: модерки нет');
    }
  });
});
</script>
</body>
</html>
